<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Person Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            color: #1a1a1a;
            line-height: 1.6;
        }

        /* Navigation */
        .navbar {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .navbar-brand {
            font-size: 20px;
            font-weight: 700;
            color: #2563eb;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .navbar-menu {
            display: flex;
            gap: 8px;
            list-style: none;
        }

        .navbar-link {
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            color: #4b5563;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }

        .navbar-link:hover {
            background: #f3f4f6;
            color: #2563eb;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* Header Section */
        .page-header {
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .page-header p {
            color: #6b7280;
            font-size: 16px;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .stat-subtitle {
            font-size: 13px;
            color: #9ca3af;
        }

        /* Content Card */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .card-body {
            padding: 24px;
        }

        /* Video Player */
        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        video {
            width: 100%;
            display: block;
            max-height: 600px;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            padding: 16px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #991b1b;
            font-size: 14px;
        }

        .error-message strong {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Person Cards */
        .person-cards {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .person-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .person-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 16px;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 16px;
        }

        .person-id {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .person-badge {
            background: #2563eb;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .person-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .person-time {
            text-align: right;
            font-size: 13px;
            color: #6b7280;
        }

        .person-time strong {
            display: block;
            color: #111827;
            font-size: 14px;
            margin-top: 4px;
        }

        .activity-section {
            margin-bottom: 16px;
        }

        .activity-title {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .timeline-item {
            padding: 12px;
            background: #f9fafb;
            border-left: 3px solid #2563eb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .zone-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .time-info {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        .duration {
            display: inline-block;
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
        }

        .line-crossing {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin: 4px 4px 4px 0;
        }

        .line-crossing.in {
            background: #d1fae5;
            color: #065f46;
        }

        .line-crossing.out {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            padding: 16px 0;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-info {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Loading State */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .loading-screen .spinner {
            border-color: #e5e7eb;
            border-top-color: #2563eb;
            width: 50px;
            height: 50px;
            margin-bottom: 16px;
        }

        .loading-screen p {
            color: #6b7280;
            font-size: 16px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar-content {
                flex-direction: column;
                height: auto;
                padding: 16px 24px;
                gap: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-bar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .person-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .person-time {
                text-align: left;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-muted {
            color: #6b7280;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .mt-4 {
            margin-top: 16px;
        }

        /* Zone Router Buttons */
        .zone-router {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .zone-btn {
            padding: 12px 24px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zone-btn:hover {
            border-color: #2563eb;
            color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .zone-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        }

        .zone-btn.staff {
            border-left: 4px solid #7c3aed;
        }

        .zone-btn.staff.active {
            background: #7c3aed;
            border-color: #7c3aed;
        }

        .zone-btn.customer {
            border-left: 4px solid #10b981;
        }

        .zone-btn.customer.active {
            background: #10b981;
            border-color: #10b981;
        }

        .zone-type-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.3);
        }

        .zone-btn.active .zone-type-badge {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Zone-specific charts */
        .zone-charts {
            display: none;
        }

        .zone-charts.active {
            display: block;
        }

        .overview-charts {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">
                <span>üìä</span> Person Analytics
            </a>
            <ul class="navbar-menu">
                <li><a href="/" class="navbar-link">Upload</a></li>
                <li><a href="/history" class="navbar-link">History</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading-screen">
            <div class="spinner"></div>
            <p>Loading analytics data...</p>
        </div>

        <!-- Content -->
        <div id="content" class="hidden">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Video Analytics Dashboard</h1>
                <p>Comprehensive tracking and analysis</p>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <a href="/history" class="btn btn-secondary">‚Üê Back to History</a>
                <button id="downloadVideo" class="btn btn-success">üíæ Download Video</button>
                <button id="downloadCSV" class="btn btn-secondary">üìä Export CSV</button>
                <button id="downloadJSON" class="btn btn-secondary">üìÑ Export JSON</button>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Video Player -->
            <div class="card">
                <div class="card-header">
                    <h2>Processed Video</h2>
                </div>
                <div class="card-body">
                    <div class="video-wrapper">
                        <video id="processedVideo" controls preload="auto">
                            <source id="videoSource" type="video/mp4">
                            Your browser does not support video playback.
                        </video>
                        <div id="videoLoading" class="video-loading hidden">
                            <div class="spinner"></div>
                            <p>Loading video...</p>
                        </div>
                    </div>
                    <div id="videoError" class="error-message hidden"></div>
                </div>
            </div>

            <!-- Zone Analytics with Tab Navigation -->
            <div class="card">
                <div class="card-header">
                    <h2>üìä Zone & Line Analytics</h2>
                </div>
                <div class="card-body">
                    <div class="zone-router" id="zoneRouter">
                        <button class="zone-btn active" data-zone="overview" onclick="switchZone('overview')">
                            üìä Overview
                        </button>
                    </div>
                </div>
            </div>

            <!-- Overview Charts (All Zones) -->
            <div id="overview-section" class="overview-charts">
                <div class="card">
                    <div class="card-header">
                        <h2>Zone Occupancy Timeline - All Zones</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="peakHoursChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone-Specific Charts (dynamically generated) -->
            <div id="zone-specific-charts"></div>

            <!-- Person Summary Table -->
            <div class="card">
                <div class="card-header">
                    <h2>Tracking Summary</h2>
                </div>
                <div class="card-body" style="padding: 0;">
                    <table id="personTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Person ID</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                                <th>Duration</th>
                                <th>Zone Visits</th>
                                <th>Line Crossings</th>
                            </tr>
                        </thead>
                        <tbody id="personTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Person Timeline -->
            <div class="card">
                <div class="card-header">
                    <h2>Detailed Activity Log</h2>
                </div>
                <div class="card-body">
                    <div class="person-cards" id="personCards"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let trackingData = null;
        let filename = null;

        // Get filename from URL
        const urlParts = window.location.pathname.split('/');
        filename = decodeURIComponent(urlParts[urlParts.length - 1]);

        // Load tracking data
        async function loadData() {
            try {
                const response = await fetch(`/tracking-data/${encodeURIComponent(filename)}`);
                if (!response.ok) throw new Error('Failed to load tracking data');
                trackingData = await response.json();
                renderDashboard();
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="error-message">
                        <strong>Error Loading Data</strong>
                        ${error.message}
                    </div>
                    <a href="/" class="btn btn-primary" style="margin-top: 20px;">Back to Home</a>
                `;
            }
        }

        async function renderDashboard() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            // Load video
            const videoElement = document.getElementById('processedVideo');
            const videoSource = document.getElementById('videoSource');
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');

            videoLoading.classList.remove('hidden');

            try {
                const response = await fetch(`/get-video-url/${encodeURIComponent(filename)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                videoSource.src = data.video_url;
                videoElement.load();

                videoElement.onerror = function() {
                    videoLoading.classList.add('hidden');
                    videoError.classList.remove('hidden');
                    videoError.innerHTML = `
                        <strong>Video Loading Error</strong>
                        Unable to load video. The file may be corrupted or in an unsupported format.
                        <div style="margin-top: 8px; font-size: 13px;">
                            Try downloading the video using the button above, or re-process it with FFmpeg installed.
                        </div>
                    `;
                };

                videoElement.onloadeddata = function() {
                    videoLoading.classList.add('hidden');
                };

            } catch (error) {
                videoLoading.classList.add('hidden');
                videoError.classList.remove('hidden');
                videoError.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }

            // Setup download buttons
            document.getElementById('downloadVideo').onclick = () => {
                window.location.href = `/download/${encodeURIComponent(filename)}`;
            };
            document.getElementById('downloadCSV').onclick = () => {
                window.location.href = `/download-csv/${encodeURIComponent(filename)}`;
            };
            document.getElementById('downloadJSON').onclick = () => {
                window.location.href = `/download-json/${encodeURIComponent(filename)}`;
            };

            // Render components
            renderStats();
            createZoneButtons();
            createZoneSpecificCharts();
            renderPersonTable();
            renderPersonCards();
            renderPeakHoursChart();
        }

        function switchZone(zoneName) {
            // Update button states
            document.querySelectorAll('.zone-btn').forEach(btn => {
                if (btn.dataset.zone === zoneName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/hide appropriate sections
            if (zoneName === 'overview') {
                document.getElementById('overview-section').style.display = 'block';
                document.querySelectorAll('.zone-charts').forEach(chart => {
                    chart.style.display = 'none';
                });
            } else {
                document.getElementById('overview-section').style.display = 'none';
                document.querySelectorAll('.zone-charts').forEach(chart => {
                    if (chart.dataset.zone === zoneName) {
                        chart.style.display = 'block';
                    } else {
                        chart.style.display = 'none';
                    }
                });
            }
        }

        function createZoneButtons() {
            const router = document.getElementById('zoneRouter');
            const zones = trackingData.zones || {};
            const lines = trackingData.summary?.line_stats || {};

            // Add zone buttons
            for (const [zoneName, zoneInfo] of Object.entries(zones)) {
                const zoneType = zoneInfo.type;
                const icon = zoneType === 'staff' ? 'üëî' : 'üë•';
                const typeLabel = zoneType === 'staff' ? 'Staff' : 'Queue';

                const button = document.createElement('button');
                button.className = `zone-btn ${zoneType}`;
                button.dataset.zone = zoneName;
                button.onclick = () => switchZone(zoneName);
                button.innerHTML = `
                    ${icon} ${zoneName}
                    <span class="zone-type-badge">${typeLabel}</span>
                `;
                router.appendChild(button);
            }

            // Add line buttons
            for (const [lineName, lineInfo] of Object.entries(lines)) {
                const button = document.createElement('button');
                button.className = 'zone-btn';
                button.dataset.zone = lineName;
                button.onclick = () => switchZone(lineName);
                button.innerHTML = `
                    ‚ÜîÔ∏è ${lineName}
                    <span class="zone-type-badge">Line</span>
                `;
                router.appendChild(button);
            }
        }

        function renderStats() {
            const stats = trackingData.summary;
            const videoInfo = trackingData.video_info;

            let html = `
                <div class="stat-card">
                    <div class="stat-label">Total Persons</div>
                    <div class="stat-value">${stats.total_persons_detected || 0}</div>
                    <div class="stat-subtitle">Tracked (${stats.total_persons_seen || 0} seen)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duration</div>
                    <div class="stat-value">${videoInfo.duration}</div>
                    <div class="stat-subtitle">${videoInfo.fps} FPS</div>
                </div>
            `;

            // Zone stats
            const zoneStats = stats.zone_stats || {};
            for (const [zoneName, count] of Object.entries(zoneStats)) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">${zoneName}</div>
                        <div class="stat-value">${count}</div>
                        <div class="stat-subtitle">Unique persons</div>
                    </div>
                `;
            }

            // Line stats
            const lineStats = stats.line_stats || {};
            for (const [lineName, counts] of Object.entries(lineStats)) {
                html += `
                    <div class="stat-card">
                        <div class="stat-label">${lineName}</div>
                        <div class="stat-value">
                            <span style="color: #10b981;">${counts.in || 0}</span> /
                            <span style="color: #ef4444;">${counts.out || 0}</span>
                        </div>
                        <div class="stat-subtitle">In / Out</div>
                    </div>
                `;
            }

            document.getElementById('statsGrid').innerHTML = html;
        }

        function renderPersonTable() {
            const tbody = document.getElementById('personTableBody');
            let html = '';

            trackingData.persons.forEach((person, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td><strong>#${person.id}</strong></td>
                        <td>${person.first_seen}</td>
                        <td>${person.last_seen}</td>
                        <td>${person.total_time}</td>
                        <td><span class="badge badge-primary">${person.total_zone_visits}</span></td>
                        <td><span class="badge badge-success">${person.total_line_crossings}</span></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || '<tr><td colspan="7" class="empty-state">No tracking data available</td></tr>';
        }

        function renderPersonCards() {
            const container = document.getElementById('personCards');
            let html = '';

            if (trackingData.persons.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No person data available</p></div>';
                return;
            }

            trackingData.persons.forEach((person, index) => {
                html += `
                    <div class="person-card">
                        <div class="person-header">
                            <div class="person-id">
                                <span class="person-badge">#${index + 1}</span>
                                <span class="person-title">Person ${person.id}</span>
                            </div>
                            <div class="person-time">
                                ${person.first_seen} ‚Üí ${person.last_seen}
                                <strong>${person.total_time}</strong>
                            </div>
                        </div>

                        ${person.zone_visits.length > 0 ? `
                            <div class="activity-section">
                                <div class="activity-title">Zone Activity</div>
                                ${person.zone_visits.map(visit => `
                                    <div class="timeline-item">
                                        <div class="zone-name">üìç ${visit.zone}</div>
                                        <div class="time-info">
                                            Entry: ${visit.entry_time}
                                            ${visit.exit_time ? `<br>Exit: ${visit.exit_time}` : '<br><em>Still in zone</em>'}
                                        </div>
                                        ${visit.duration ? `<span class="duration">${visit.duration}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="empty-state" style="padding: 20px 0;"><p style="font-size: 14px;">No zone visits recorded</p></div>'}

                        ${person.line_crossings.length > 0 ? `
                            <div class="activity-section">
                                <div class="activity-title">Line Crossings</div>
                                ${person.line_crossings.map(crossing => `
                                    <span class="line-crossing ${crossing.direction}">
                                        ${crossing.line}: ${crossing.direction.toUpperCase()} at ${crossing.time}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderPeakHoursChart() {
            const zones = new Set();
            trackingData.persons.forEach(person => {
                person.zone_visits.forEach(visit => zones.add(visit.zone));
            });

            if (zones.size === 0) {
                document.querySelector('.chart-container').innerHTML = '<div class="empty-state"><p>No zone data available</p></div>';
                return;
            }

            const fps = trackingData.video_info.fps;
            const totalFrames = trackingData.video_info.total_frames;
            const videoDurationSeconds = totalFrames / fps;
            const bucketSize = 30;
            const numBuckets = Math.ceil(videoDurationSeconds / bucketSize);

            const timeLabels = [];
            const zoneData = {};

            for (let i = 0; i < numBuckets; i++) {
                const seconds = i * bucketSize;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timeLabels.push(`${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`);
            }

            zones.forEach(zone => {
                zoneData[zone] = new Array(numBuckets).fill(0);
            });

            trackingData.persons.forEach(person => {
                person.zone_visits.forEach(visit => {
                    const entryParts = visit.entry_time.split(':');
                    const entrySeconds = parseInt(entryParts[0]) * 60 + parseInt(entryParts[1]);

                    let exitSeconds;
                    if (visit.exit_time) {
                        const exitParts = visit.exit_time.split(':');
                        exitSeconds = parseInt(exitParts[0]) * 60 + parseInt(exitParts[1]);
                    } else {
                        exitSeconds = videoDurationSeconds;
                    }

                    for (let i = 0; i < numBuckets; i++) {
                        const bucketStart = i * bucketSize;
                        const bucketEnd = (i + 1) * bucketSize;

                        if (entrySeconds < bucketEnd && exitSeconds > bucketStart) {
                            zoneData[visit.zone][i]++;
                        }
                    }
                });
            });

            const colors = [
                '#2563eb', '#7c3aed', '#db2777', '#dc2626',
                '#ea580c', '#ca8a04', '#16a34a', '#0891b2'
            ];

            const datasets = [];
            let colorIndex = 0;

            zones.forEach(zoneName => {
                const color = colors[colorIndex % colors.length];
                datasets.push({
                    label: zoneName,
                    data: zoneData[zoneName],
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 5
                });
                colorIndex++;
            });

            const ctx = document.getElementById('peakHoursChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12, weight: '600' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' person(s)';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: { size: 11 }
                            },
                            title: {
                                display: true,
                                text: 'Number of People',
                                font: { size: 13, weight: '600' }
                            },
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (MM:SS)',
                                font: { size: 13, weight: '600' }
                            },
                            grid: {
                                color: '#f3f4f6'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // Zone switching functionality
        let currentZone = 'overview';
        let zoneCharts = {};

        function switchZone(zoneName) {
            currentZone = zoneName;

            // Update button states
            document.querySelectorAll('.zone-btn').forEach(btn => {
                if (btn.dataset.zone === zoneName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/hide appropriate sections
            if (zoneName === 'overview') {
                document.getElementById('overview-section').style.display = 'block';
                document.querySelectorAll('.zone-charts').forEach(chart => {
                    chart.style.display = 'none';
                });
            } else {
                document.getElementById('overview-section').style.display = 'none';
                document.querySelectorAll('.zone-charts').forEach(chart => {
                    if (chart.dataset.zone === zoneName) {
                        chart.style.display = 'block';
                    } else {
                        chart.style.display = 'none';
                    }
                });
            }
        }

        function createZoneButtons() {
            const router = document.getElementById('zoneRouter');
            const zones = trackingData.zones || {};
            const lines = trackingData.summary?.line_stats || {};

            // Add zone buttons
            for (const [zoneName, zoneInfo] of Object.entries(zones)) {
                const zoneType = zoneInfo.type;
                const icon = zoneType === 'staff' ? 'üëî' : 'üë•';
                const typeLabel = zoneType === 'staff' ? 'Staff' : 'Queue';

                const button = document.createElement('button');
                button.className = `zone-btn ${zoneType}`;
                button.dataset.zone = zoneName;
                button.onclick = () => switchZone(zoneName);
                button.innerHTML = `
                    ${icon} ${zoneName}
                    <span class="zone-type-badge">${typeLabel}</span>
                `;
                router.appendChild(button);
            }

            // Add line buttons
            for (const [lineName, lineInfo] of Object.entries(lines)) {
                const button = document.createElement('button');
                button.className = 'zone-btn';
                button.dataset.zone = lineName;
                button.onclick = () => switchZone(lineName);
                button.innerHTML = `
                    ‚ÜîÔ∏è ${lineName}
                    <span class="zone-type-badge">Line</span>
                `;
                router.appendChild(button);
            }
        }

        function createZoneSpecificCharts() {
            const container = document.getElementById('zone-specific-charts');
            const zones = trackingData.zones || {};
            const lines = trackingData.summary?.line_stats || {};

            console.log('=== DEBUG: createZoneSpecificCharts ===');
            console.log('Zones found:', Object.keys(zones).length);
            console.log('Lines found:', Object.keys(lines).length);
            console.log('Zones:', zones);
            console.log('Lines:', lines);

            // Create zone charts
            for (const [zoneName, zoneInfo] of Object.entries(zones)) {
                console.log('Creating chart for zone:', zoneName, zoneInfo);
                const zoneType = zoneInfo.type;

                // Create zone-specific chart section
                const zoneSection = document.createElement('div');
                zoneSection.className = 'zone-charts';
                zoneSection.dataset.zone = zoneName;

                if (zoneType === 'staff') {
                    // Staff Zone: Activity Timeline with Analysis
                    zoneSection.innerHTML = `
                        <div style="display: grid; grid-template-columns: 60% 40%; gap: 20px;">
                            <div class="card">
                                <div class="card-header">
                                    <h2>üëî ${zoneName} - Staff Activity Timeline</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="chart-${zoneName.replace(/\s+/g, '-')}"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h2>üìä Analysis</h2>
                                </div>
                                <div class="card-body">
                                    <div id="analysis-${zoneName.replace(/\s+/g, '-')}"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Queue/Customer Zone: Occupancy Count with Analysis
                    zoneSection.innerHTML = `
                        <div style="display: grid; grid-template-columns: 60% 40%; gap: 20px;">
                            <div class="card">
                                <div class="card-header">
                                    <h2>üë• ${zoneName} - Queue Occupancy</h2>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="chart-${zoneName.replace(/\s+/g, '-')}"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h2>üìä Analysis</h2>
                                </div>
                                <div class="card-body">
                                    <div id="analysis-${zoneName.replace(/\s+/g, '-')}"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.appendChild(zoneSection);

                // Render the chart and analysis
                renderZoneChart(zoneName, zoneType);
                renderZoneAnalysis(zoneName, zoneType, zoneInfo);
            }

            // Create line charts
            for (const [lineName, lineInfo] of Object.entries(lines)) {
                const lineSection = document.createElement('div');
                lineSection.className = 'zone-charts';
                lineSection.dataset.zone = lineName;

                // Line: Split view with IN on left, OUT on right, Analysis below
                lineSection.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2 style="color: #10b981;">‚ÜîÔ∏è ${lineName} - IN</h2>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chart-${lineName.replace(/\s+/g, '-')}-in"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h2 style="color: #ef4444;">‚ÜîÔ∏è ${lineName} - OUT</h2>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="chart-${lineName.replace(/\s+/g, '-')}-out"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2>üìä Line Analysis</h2>
                        </div>
                        <div class="card-body">
                            <div id="analysis-${lineName.replace(/\s+/g, '-')}"></div>
                        </div>
                    </div>
                `;

                container.appendChild(lineSection);

                // Render the line charts and analysis
                renderLineCharts(lineName, lineInfo);
                renderLineAnalysis(lineName, lineInfo);
            }
        }

        function renderZoneChart(zoneName, zoneType) {
            const canvasId = `chart-${zoneName.replace(/\s+/g, '-')}`;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const fps = trackingData.video_info.fps;
            const totalFrames = trackingData.video_info.total_frames;
            const videoDurationSeconds = totalFrames / fps;

            if (zoneType === 'staff') {
                // Staff Zone: Show activity periods (when staff was in the zone)
                renderStaffActivityChart(ctx, zoneName, videoDurationSeconds, fps);
            } else {
                // Queue Zone: Show number of people over time
                renderQueueOccupancyChart(ctx, zoneName, videoDurationSeconds, fps);
            }
        }

        function renderStaffActivityChart(ctx, zoneName, videoDurationSeconds, fps) {
            // Use timeline data from backend (5-second intervals)
            const zoneData = trackingData.zones[zoneName];
            if (!zoneData || !zoneData.timeline) {
                console.error('No timeline data for zone:', zoneName);
                return;
            }

            const timeline = zoneData.timeline;
            const timeLabels = timeline.map(point => point.time);
            const activityData = timeline.map(point => point.active);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Staff Active',
                        data: activityData,
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        borderColor: '#7c3aed',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        stepped: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 12, weight: '600' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y === 1 ? 'Staff Active' : 'Not Active';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value === 1 ? 'Active' : 'Inactive';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Activity Status',
                                font: { size: 13, weight: '600' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (MM:SS)',
                                font: { size: 13, weight: '600' }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderQueueOccupancyChart(ctx, zoneName, videoDurationSeconds, fps) {
            // Use timeline data from backend (per-second intervals)
            const zoneData = trackingData.zones[zoneName];
            if (!zoneData || !zoneData.timeline) {
                console.error('No timeline data for zone:', zoneName);
                return;
            }

            const timeline = zoneData.timeline;
            const timeLabels = timeline.map(point => point.time);
            const countData = timeline.map(point => point.count);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Number of People',
                        data: countData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 12, weight: '600' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const count = context.parsed.y;
                                    return `${count} ${count === 1 ? 'person' : 'people'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of People',
                                font: { size: 13, weight: '600' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (MM:SS)',
                                font: { size: 13, weight: '600' }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderLineCharts(lineName, lineInfo) {
            // Use timeline data from backend
            if (!lineInfo.timeline || lineInfo.timeline.length === 0) {
                console.error('No timeline data for line:', lineName);
                return;
            }

            const timeline = lineInfo.timeline;
            const timeLabels = timeline.map(point => point.time);
            const inCounts = timeline.map(point => point.in_count);
            const outCounts = timeline.map(point => point.out_count);

            const canvasIdIn = `chart-${lineName.replace(/\s+/g, '-')}-in`;
            const canvasIdOut = `chart-${lineName.replace(/\s+/g, '-')}-out`;
            const ctxIn = document.getElementById(canvasIdIn);
            const ctxOut = document.getElementById(canvasIdOut);

            if (!ctxIn || !ctxOut) {
                console.error('Canvas elements not found for line:', lineName);
                return;
            }

            // IN Chart (cumulative)
            new Chart(ctxIn, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'IN Count',
                        data: inCounts,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 12, weight: '600' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `IN: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Cumulative IN Count',
                                font: { size: 13, weight: '600' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (MM:SS)',
                                font: { size: 13, weight: '600' }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // OUT Chart (cumulative)
            new Chart(ctxOut, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'OUT Count',
                        data: outCounts,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 12, weight: '600' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `OUT: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Cumulative OUT Count',
                                font: { size: 13, weight: '600' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (MM:SS)',
                                font: { size: 13, weight: '600' }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderZoneAnalysis(zoneName, zoneType, zoneInfo) {
            const analysisId = `analysis-${zoneName.replace(/\s+/g, '-')}`;
            const container = document.getElementById(analysisId);

            if (!container) {
                console.error('Analysis container not found for:', zoneName);
                return;
            }

            if (zoneType === 'staff') {
                // Staff Zone Analysis
                const timeline = zoneInfo.timeline || [];
                const totalIntervals = timeline.length;
                const activeIntervals = timeline.filter(t => t.active === 1).length;
                const inactiveIntervals = timeline.filter(t => t.active === 0).length;
                const activePercentage = totalIntervals > 0 ? ((activeIntervals / totalIntervals) * 100).toFixed(1) : 0;
                const totalDuration = totalIntervals * 5; // 5-second intervals
                const activeDuration = activeIntervals * 5;

                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <h3 style="font-size: 18px; margin-bottom: 15px; color: #333;">Activity Summary</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Active Intervals</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #10b981;">${activeIntervals}</div>
                                    <div style="font-size: 11px; color: #888;">${activeDuration}s total</div>
                                </div>
                                <div style="background: #fef2f2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Inactive Intervals</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${inactiveIntervals}</div>
                                    <div style="font-size: 11px; color: #888;">${inactiveIntervals * 5}s total</div>
                                </div>
                                <div style="background: #eff6ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Activity Rate</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${activePercentage}%</div>
                                    <div style="font-size: 11px; color: #888;">of total time</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 style="font-size: 18px; margin-bottom: 10px; color: #333;">Insights</h3>
                            <div style="font-size: 13px; color: #555; line-height: 1.6;">
                                ${activePercentage > 70 ?
                                    '<div style="padding: 10px; background: #fef3c7; border-radius: 6px; margin-bottom: 8px;">‚ö†Ô∏è High activity zone - consider staffing optimization</div>' :
                                    activePercentage < 30 ?
                                    '<div style="padding: 10px; background: #dbeafe; border-radius: 6px; margin-bottom: 8px;">‚ÑπÔ∏è Low activity zone - may need attention</div>' :
                                    '<div style="padding: 10px; background: #d1fae5; border-radius: 6px; margin-bottom: 8px;">‚úì Moderate activity levels</div>'}
                                <div style="margin-top: 8px; color: #666;">
                                    <strong>Total Duration:</strong> ${Math.floor(totalDuration / 60)}m ${totalDuration % 60}s<br>
                                    <strong>Sampling Interval:</strong> 5 seconds<br>
                                    <strong>Total Samples:</strong> ${totalIntervals}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Customer Zone Analysis
                const timeline = zoneInfo.timeline || [];
                const counts = timeline.map(t => t.count);
                const avgOccupancy = counts.length > 0 ? (counts.reduce((a, b) => a + b, 0) / counts.length).toFixed(1) : 0;
                const maxOccupancy = counts.length > 0 ? Math.max(...counts) : 0;
                const minOccupancy = counts.length > 0 ? Math.min(...counts) : 0;
                const totalSeconds = timeline.length;

                // Calculate peak times
                const peakThreshold = maxOccupancy * 0.8;
                const peakSeconds = counts.filter(c => c >= peakThreshold).length;
                const peakPercentage = totalSeconds > 0 ? ((peakSeconds / totalSeconds) * 100).toFixed(1) : 0;

                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <h3 style="font-size: 18px; margin-bottom: 15px; color: #333;">Occupancy Summary</h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Average Occupancy</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${avgOccupancy}</div>
                                    <div style="font-size: 11px; color: #888;">people per second</div>
                                </div>
                                <div style="background: #fef2f2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Peak Occupancy</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${maxOccupancy}</div>
                                    <div style="font-size: 11px; color: #888;">max people</div>
                                </div>
                                <div style="background: #eff6ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Peak Time</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${peakPercentage}%</div>
                                    <div style="font-size: 11px; color: #888;">of duration</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 style="font-size: 18px; margin-bottom: 10px; color: #333;">Insights</h3>
                            <div style="font-size: 13px; color: #555; line-height: 1.6;">
                                ${avgOccupancy > 5 ?
                                    '<div style="padding: 10px; background: #fef3c7; border-radius: 6px; margin-bottom: 8px;">‚ö†Ô∏è High queue occupancy - consider adding resources</div>' :
                                    avgOccupancy < 2 ?
                                    '<div style="padding: 10px; background: #d1fae5; border-radius: 6px; margin-bottom: 8px;">‚úì Low queue occupancy - good flow</div>' :
                                    '<div style="padding: 10px; background: #dbeafe; border-radius: 6px; margin-bottom: 8px;">‚ÑπÔ∏è Moderate queue levels</div>'}
                                <div style="margin-top: 8px; color: #666;">
                                    <strong>Min Occupancy:</strong> ${minOccupancy} people<br>
                                    <strong>Sampling Interval:</strong> 1 second<br>
                                    <strong>Total Samples:</strong> ${totalSeconds}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderLineAnalysis(lineName, lineInfo) {
            const analysisId = `analysis-${lineName.replace(/\s+/g, '-')}`;
            const container = document.getElementById(analysisId);

            if (!container) {
                console.error('Analysis container not found for line:', lineName);
                return;
            }

            const timeline = lineInfo.timeline || [];
            const totalIn = lineInfo.in || 0;
            const totalOut = lineInfo.out || 0;
            const netFlow = totalIn - totalOut;
            const totalCrossings = totalIn + totalOut;

            // Calculate flow rate
            const totalSeconds = timeline.length > 0 ? timeline[timeline.length - 1].time_seconds : 0;
            const flowRateIn = totalSeconds > 0 ? (totalIn / (totalSeconds / 60)).toFixed(1) : 0;
            const flowRateOut = totalSeconds > 0 ? (totalOut / (totalSeconds / 60)).toFixed(1) : 0;

            // Find busiest period
            let maxFlowRate = 0;
            let busiestTime = 'N/A';
            if (timeline.length > 10) {
                for (let i = 10; i < timeline.length; i++) {
                    const inDelta = timeline[i].in_count - timeline[i - 10].in_count;
                    const outDelta = timeline[i].out_count - timeline[i - 10].out_count;
                    const flowRate = inDelta + outDelta;
                    if (flowRate > maxFlowRate) {
                        maxFlowRate = flowRate;
                        busiestTime = timeline[i].time;
                    }
                }
            }

            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <h3 style="font-size: 18px; margin-bottom: 15px; color: #333;">Crossing Summary</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Total IN</div>
                                <div style="font-size: 28px; font-weight: bold; color: #10b981;">${totalIn}</div>
                                <div style="font-size: 11px; color: #888;">${flowRateIn} per min</div>
                            </div>
                            <div style="background: #fef2f2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Total OUT</div>
                                <div style="font-size: 28px; font-weight: bold; color: #ef4444;">${totalOut}</div>
                                <div style="font-size: 11px; color: #888;">${flowRateOut} per min</div>
                            </div>
                            <div style="background: ${netFlow > 0 ? '#eff6ff' : '#fef3c7'}; padding: 12px; border-radius: 8px; border-left: 4px solid ${netFlow > 0 ? '#3b82f6' : '#f59e0b'};">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Net Flow</div>
                                <div style="font-size: 28px; font-weight: bold; color: ${netFlow > 0 ? '#3b82f6' : '#f59e0b'};">${netFlow > 0 ? '+' : ''}${netFlow}</div>
                                <div style="font-size: 11px; color: #888;">${netFlow > 0 ? 'more IN' : netFlow < 0 ? 'more OUT' : 'balanced'}</div>
                            </div>
                            <div style="background: #f5f3ff; padding: 12px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Total Crossings</div>
                                <div style="font-size: 28px; font-weight: bold; color: #8b5cf6;">${totalCrossings}</div>
                                <div style="font-size: 11px; color: #888;">both directions</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 style="font-size: 18px; margin-bottom: 10px; color: #333;">Insights</h3>
                        <div style="font-size: 13px; color: #555; line-height: 1.6;">
                            ${Math.abs(netFlow) > totalCrossings * 0.3 ?
                                `<div style="padding: 10px; background: #fef3c7; border-radius: 6px; margin-bottom: 8px;">‚ö†Ô∏è Unbalanced flow detected - ${netFlow > 0 ? 'more entries than exits' : 'more exits than entries'}</div>` :
                                '<div style="padding: 10px; background: #d1fae5; border-radius: 6px; margin-bottom: 8px;">‚úì Balanced flow pattern</div>'}
                            <div style="margin-top: 8px; color: #666;">
                                <strong>Busiest Period:</strong> ${busiestTime}<br>
                                <strong>IN/OUT Ratio:</strong> ${totalOut > 0 ? (totalIn / totalOut).toFixed(2) : 'N/A'}<br>
                                <strong>Average Flow:</strong> ${(totalCrossings / (totalSeconds / 60)).toFixed(1)} crossings/min
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
